# Build System Documentation

## Overview

The SDK uses a **two-step build process** to create a completely self-contained package with zero external dependencies.

## Build Tools

### 1. **tsup** - JavaScript Bundler

Bundles the TypeScript source code into optimized JavaScript.

**What it does:**

- Compiles TypeScript → JavaScript
- Generates both CommonJS (`.js`) and ESM (`.mjs`) formats
- Creates source maps for debugging
- Generates initial TypeScript declaration files

### 2. **dts-bundle-generator** - Type Bundler

Inlines all external type imports into a single declaration file.

**What it does:**

- Reads the `.d.ts` files generated by tsup
- Follows imports to `@prompti/shared` (workspace package)
- Inlines those type definitions directly
- Outputs a single, self-contained `.d.ts` file with NO external references

## Build Process

```bash
pnpm build
```

This runs:

```
tsup && dts-bundle-generator -o dist/index.d.ts src/index.ts --no-check && dts-bundle-generator -o dist/index.d.mts src/index.ts --no-check
```

### Step-by-Step:

1. **tsup** runs first:
   - Bundles `src/` → `dist/index.js` (CJS)
   - Bundles `src/` → `dist/index.mjs` (ESM)
   - Creates temp `dist/index.d.ts` (with references to `@prompti/shared`)

2. **dts-bundle-generator** runs (CJS types):
   - Reads `src/index.ts`
   - Follows all imports including `@prompti/shared`
   - Inlines the actual type definitions
   - Overwrites `dist/index.d.ts` with bundled version

3. **dts-bundle-generator** runs again (ESM types):
   - Same process for `dist/index.d.mts`

## Output

```
dist/
├── index.js        # ~7KB - CommonJS bundle
├── index.mjs       # ~7KB - ESM bundle
├── index.d.ts      # ~9KB - CJS type declarations (fully inlined)
├── index.d.mts     # ~9KB - ESM type declarations (fully inlined)
├── index.js.map    # ~14KB - CJS source map
└── index.mjs.map   # ~14KB - ESM source map
```

## Key Features

### ✅ Zero External Dependencies

The published package has **zero runtime dependencies**. Users install one package, not two.

### ✅ Workspace Types Auto-Bundled

Types from `@prompti/shared` are automatically pulled in at build time. No manual copying needed!

### ✅ Always In Sync

Since we import from `@prompti/shared` directly, if shared types change, the SDK automatically gets the updates on next build.

### ✅ Self-Contained

The final `.d.ts` files have NO references to `@prompti/shared` - everything is inlined.

## Verification

To verify the build is working correctly:

```bash
# Check no references to @prompti/shared in output
grep "@prompti/shared" dist/index.d.ts
# Should return nothing

# Check TypeScript
pnpm typecheck
# Should pass with no errors

# Check bundle sizes
ls -lh dist/
```

## Development Workflow

During development, the SDK has `@prompti/shared` as a workspace dependency:

```json
{
  "dependencies": {
    "@prompti/shared": "workspace:*"
  }
}
```

This links to the local `shared/` package, so:

- IDE autocomplete works
- Type checking works
- Changes to shared are immediately reflected

But when we build and publish, the types are inlined, so end users don't need `@prompti/shared`.

## Publishing

When you run `pnpm publish`, the build happens automatically via the `prepublishOnly` script:

```json
{
  "scripts": {
    "prepublishOnly": "pnpm clean && pnpm build"
  }
}
```

This ensures the package is always built fresh before publishing.

## Configuration Files

### `tsup.config.ts`

Configures the JavaScript bundling:

- Entry point: `src/index.ts`
- Output formats: CJS + ESM
- Target: Node 18+
- Source maps: Enabled
- Tree-shaking: Enabled

### No config needed for dts-bundle-generator

It works by following imports from the entry point. The `--no-check` flag skips type checking (since we already do that with `tsc`).

## Troubleshooting

### "Cannot find module @prompti/shared"

- Make sure you've run `pnpm install` at the workspace root
- Check that `shared/` package is built (`cd shared && pnpm build`)

### Types not inlining

- Make sure dts-bundle-generator is installed
- Check the build script includes the dts-bundle-generator commands
- Verify the `@prompti/shared` workspace dependency is in package.json

### Build is slow

The build takes ~3 seconds total, which is normal for:

- TypeScript compilation
- Dual format bundling
- Type bundling for both formats

## Comparison: Before vs After

### Before (Manual Copy - Not Used)

```typescript
// Would require manual copying of types
export type PromptInput = Record<...>
export interface PromptVersionClient { ... }
```

**Pros:** Simple, no tools
**Cons:** Manual sync, duplication

### After (Auto-Bundle)

```typescript
// sdk/src/admin.ts
import { PromptInput, PromptVersionClient } from '@prompti/shared'

// sdk/src/public.ts
import {
  CreateFeedbackRequestSchema,
  UpdateFeedbackRequestSchema,
} from '@prompti/shared'
```

**Pros:** Auto-sync, DRY, always up-to-date
**Cons:** Slightly more complex build (but automated)

## Summary

The SDK now uses **best-of-both-worlds**:

- ✅ Use types from `@prompti/shared` directly (no manual copying)
- ✅ Publish as standalone package (types auto-bundled)
- ✅ Zero external dependencies for end users
- ✅ Changes to shared types automatically sync

This is the **recommended approach** for monorepo SDKs with internal type dependencies.
